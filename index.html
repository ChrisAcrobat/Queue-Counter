<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Queue counter</title>
		<meta content="width=device-width, initial-scale=1.0" name="viewport">
		<meta content="yes" name="mobile-web-app-capable">
		<style>
			@font-face{
				font-family:'digital-clock-font';
				src: url('digital-7/digital-7 (mono).ttf');
			}
			html, body, #counter {
				height: 100%;
				margin: 0;
				padding: 0;
				color: white;
				background-color: black;
			}
			#error-message {
				color: red;
			}
			#admin {
				color: black;
				background-color: white;
				height: 100%;
			}
			#admin > * {
				padding: 8px;
			}
			#terminals {
				width: fit-content;
			}
			.center-height {
				display: flex;
				height: 100%;
				justify-content: center;
				align-items: center;
			}
			.center-width {
				display: flex;
				justify-content: center;
				align-items: center;
			}
			#counters {
				cursor: none;
				user-select: none;
				color: red;
				font-family: 'digital-clock-font';
				font-size: 100vmin;
			}
			fieldset {
				display: block !important;
				border-color: var(--main-color);
				margin-bottom: 8px;
			}
			fieldset>legend {
				cursor: pointer;
				user-select: none;
			}
			fieldset>legend::after {
				content: ' ▼';
			}
			fieldset.hidden>legend::after {
				content: ' ▲';
			}
			fieldset.hidden>:not(legend) {
				display: none;
			}
			.hidden {
				display: none;
			}
			.invisible {
				visibility: hidden;
			}
		</style>
		<script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
		<script>
			'use strict'
			function a(){
				let element_joinRoom = document.getElementById('join-room');
				let element_admin = document.getElementById('admin');
				let element_peerId = document.getElementById('peer-id');
				let element_peerIdSelect = document.getElementById('peer-id-select');
				let element_btnJoin = document.getElementById('btn-join');
				let element_btnHost = document.getElementById('btn-host');
				let element_terminals = document.getElementById('terminals');
				let element_terminal = document.getElementById('terminal');queues
				let element_addQueue = document.getElementById('add-queue');
				let element_queues = document.getElementById('queues');
				let notification = new Audio('Computer Error-SoundBible.com-1655839472.wav');
				let peer;
				element_btnHost.addEventListener('click', ()=>{
					let state = {
						terminals: [
							{
								id: '3343234-655435-342324',
								display: [
									{
										queue: 'name',
										displayName: false,
										ticketRaiser: false
									}
								]
							}
						],
						queues: [
							{
								name: 'name',
								value: 0,
								ticketsRaised: 1
							}
						]
					};
					let connections = [];
					function syncState(previousState){
						let currentState = JSON.stringify(state);
						if(previousState !== currentState){
							connections.forEach(dataConnection => {
								dataConnection.send({type: 'state-update', value: JSON.parse(currentState)});
							});
						}
						setTimeout(syncState, 100, currentState);
					}
					syncState();
					function addTerminal(dataConnection){
						connections.push(dataConnection.peer);
						let div = document.createElement('div');
						div.innerHTML = dataConnection.peer;
						div.id = 'terminal-'+dataConnection.peer;
						element_terminals.appendChild(div);
					}
					function removeTerminal(dataConnection){
						let index = connections.findIndex(d => d === dataConnection);
						if(-1 < index){
							connections.splice(index, 1);
						}
						let div = document.getElementById('terminal-'+dataConnection.peer);
						div.parentElement.remove(div);
					}
					element_addQueue.addEventListener('click', ()=>{
						function validateAndUpdate(){
							queueNumber.valueAsNumber = Math.max(queueNumber.min, (queueNumber.valueAsNumber)%queueNumber.max);
							state.queues.filter(q => q.name).forEach(q => q.value = queueNumber.valueAsNumber);
						}
						let fieldset = document.createElement('fieldset');
						let legend = document.createElement('legend');
						do{
							legend.innerHTML = prompt('Name of the queue:');
							if(legend.innerHTML === ''){
								alert('Error: Queue has to have a name.');
							}
							if([...document.getElementsByTagName('legend')].find(l => l.innerHTML === legend.innerHTML)){
								alert('Error: Name already given to another queue.');
								legend.innerHTML = '';
							}
						}while(legend.innerHTML === '');
						fieldset.appendChild(legend);
						let queueNumber = document.createElement('input');
						queueNumber.type = 'number';
						queueNumber.value = 1;
						queueNumber.min = 1;
						queueNumber.max = 10;
						queueNumber.onkeyup = keyboardEvent => {
							if(keyboardEvent.code === 'Space'){
								queueNumber.valueAsNumber++;
								validateAndUpdate();
							}
						}
						queueNumber.onchange = validateAndUpdate;
						fieldset.appendChild(queueNumber);
						element_queues.appendChild(fieldset);
					});
					document.body.addEventListener('click', pointerEvent=>{
						if(pointerEvent.srcElement.localName === 'legend'){
							pointerEvent.srcElement.parentElement.classList.toggle('hidden');
						}
					});
					peer = createPeer(element_peerIdSelect.value, ID => {
						element_peerId.innerHTML = ID;
						element_admin.classList.remove('hidden');
						peer.on('connection', dataConnection => {
							dataConnection.on('open', ()=>{
								addTerminal(dataConnection);
								dataConnection.send(state);
							});
							dataConnection.on('data', data => {
								switch(data.type){
									case 'queue-change':
										break
								}
							});
							dataConnection.on('close', ()=>{
								removeTerminal(dataConnection);
							});
						});
					});
				});
				element_btnJoin.addEventListener('click', ()=>{
					element_joinRoom.classList.add('hidden');
					document.getElementById('select-mode').classList.remove('hidden');
					peer = createPeer(undefined, ID=>{
						console.log('// TODO: Display ID ('+ID+') if terminals is empty.');
						let dataConnection = peer.connect(element_peerIdSelect.value);
						dataConnection.on('open', ()=>{
							// Send messages
							dataConnection.send('2!');
							// Receive messages
							dataConnection.on('data', data => {
								switch(data.type){
									case 'state-update':
										console.log(data.value);
										break
								}
							});
						});
					});
				});
				function createPeer(id='', callback=()=>{}){
					let peer = new Peer(id.toLocaleLowerCase());
					element_peerIdSelect.disabled = true;
					element_btnHost.disabled = true;
					element_btnJoin.disabled = true;
					peer.on('open', ID =>{
						element_joinRoom.classList.add('hidden');
						callback(ID);
					});
					peer.on('error', err => {
						element_peerIdSelect.disabled = false;
						element_btnHost.disabled = false;
						element_btnJoin.disabled = false;
						document.getElementById('error-message').innerHTML = err;
						document.getElementById('error-message').classList.remove('invisible');
					});
					return peer;
				}
				function raise(elementCounter){
					let currentValue = parseInt(elementCounter.innerHTML);
					elementCounter.innerHTML = Math.max(1, (currentValue+1)%10);
					notification.play();
				}
			}
		</script>
	</head>
	<body onload="a()">
		<div id="join-room" class="center-height">
			<div>
				<div class="center-width">
					<i>Queue ID</i>
				</div>
				<div class="center-width">
					<input id="peer-id-select" type="text">
				</div>
				<div class="center-width">
					<input id="btn-host" type="button" value="Host">
					<input id="btn-join" type="button" value="Join">
				</div>
				<div id="error-message" class="invisible center-width"></div>
			</div>
		</div>
		<div id="select-mode" class="hidden"></div>
		<div id="admin" class="hidden">
			<div>
				<div>
					<b>Queue ID:</b>
					<span id="peer-id"></span>
				</div>
				<div>
					<fieldset id="terminals">
						<legend>Terminals</legend>
					</fieldset>
					<fieldset id="queues">
						<legend>Queues</legend>
						<input id="add-queue" type="button" value="Add queue">
					</fieldset>
				</div>
			</div>
		</div>
		<div id="terminal" class="hidden"></div>
		<div id="queue-ticket" class="hidden">
			<!--
				TODO:
					1. List all queues.
					2. When click on queue, next ticket is displayed and stored.
					3. When ticket is current a sound is played from device.
			-->
		</div>
	</body>
</html>
